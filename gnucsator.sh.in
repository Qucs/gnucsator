#!/bin/sh
# this is gnucsator, gnucap in qucsator mode.
# it loads plugins and switches to qucs language.
#
# this sucks.
# to be replaced by a "qucsator" binary, once
# shared library and output pluggability are ready.
# the .sh extension is intentional.

@NOTICE@

if [ "$1" != -i ]; then
	echo "usage $0 -i <file>"
	exit 1
fi

GNUCAP=gnucap@SUFFIX@
GNUCAP_LIBDIR=@GNUCAP_LIBDIR@

# don't even try to parse large data sets
# write this in C -- it's still stupid.
postproc()
{
	while read i; do
		if [ "${i:0:5}"x = "#Timex" ]; then
			probes=( ${i:5:${#i}} )
			break;
		fi
	done
	n=0
	m=0
	while read line; do
		[ -z "$line" ] && break;
		[ "${line:0:4}" = "open" ] && continue;
		[ "${line:0:1}" = "#" ] && break;
		m=0
		for tmp in $line; do
			eval "data_${n}_$m=\"$tmp\""
			m=`expr $m + 1`
		done
		n=`expr $n + 1`
	done
	m=`expr $m - 2`
	echo "<indep time $n>"
	n=`expr $n - 1`
	for i in `seq 0 $n`; do
		eval "echo \$data_${i}_0"
	done
	echo "</indep>"
	for i in `seq 0 $m`; do
		tmp="${probes[$i]}"
		br=${tmp##*(}
		echo "<dep ${br:0:-1}.${tmp%%(*}t time>"
		for j in `seq 0 $n`; do
			eval "echo \ \ \$data_${j}_$i"
		done
		echo "</dep>"
	done
}

if [ -z "$LD_LIBRARY_PATH" ]; then
	export LD_LIBRARY_PATH=$GNUCAP_LIBDIR/qucs
fi

postproc=${postproc-postproc}

($GNUCAP | $postproc) <<EOF
load bm_value.so
load bm_wrapper.so
load bm_trivial.so
load cmd_wrapper.so
load d_probe.so
*load d_qucs_opamp.so
load lang_qucs.so
load functions.so
qucs
include $2
EOF
